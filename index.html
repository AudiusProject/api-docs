
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Hedgehog Documentation</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight {
  color: #faf6e4;
  background-color: #122b3b;
}
.highlight .gl {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #6c8b9f;
  font-style: italic;
}
.highlight .cp {
  color: #b2fd6d;
  font-weight: bold;
  font-style: italic;
}
.highlight .err {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .gr {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .k, .highlight .kd, .highlight .kv {
  color: #f6dd62;
  font-weight: bold;
}
.highlight .o, .highlight .ow {
  color: #4df4ff;
}
.highlight .p, .highlight .pi {
  color: #4df4ff;
}
.highlight .gd {
  color: #cc0000;
}
.highlight .gi {
  color: #b2fd6d;
}
.highlight .ge {
  font-style: italic;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gt {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .kc {
  color: #f696db;
  font-weight: bold;
}
.highlight .kn {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kp {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kr {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gh {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gu {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kt {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .no {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nc {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nd {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nn {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .bp {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .ne {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nl {
  color: #ffb000;
  font-weight: bold;
}
.highlight .nt {
  color: #ffb000;
  font-weight: bold;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #f696db;
  font-weight: bold;
}
.highlight .ld {
  color: #f696db;
  font-weight: bold;
}
.highlight .ss {
  color: #f696db;
  font-weight: bold;
}
.highlight .s, .highlight .sb, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .sr, .highlight .s1 {
  color: #fff0a6;
  font-weight: bold;
}
.highlight .se {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .sc {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .si {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .nb {
  font-weight: bold;
}
.highlight .ni {
  color: #999999;
  font-weight: bold;
}
.highlight .w {
  color: #BBBBBB;
}
.highlight .nf {
  color: #a8e1fe;
}
.highlight .py {
  color: #a8e1fe;
}
.highlight .na {
  color: #a8e1fe;
}
.highlight .nv, .highlight .vc, .highlight .vg, .highlight .vi {
  color: #a8e1fe;
  font-weight: bold;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#installation" class="toc-h1 toc-link" data-title="Installation">Installation</a>
          </li>
          <li>
            <a href="#overview" class="toc-h1 toc-link" data-title="Overview">Overview</a>
          </li>
          <li>
            <a href="#how-it-works" class="toc-h1 toc-link" data-title="How It Works">How It Works</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#wallet-creation" class="toc-h2 toc-link" data-title="Wallet Creation">Wallet Creation</a>
                  </li>
                  <li>
                    <a href="#wallet-persistence" class="toc-h2 toc-link" data-title="Wallet Persistence">Wallet Persistence</a>
                  </li>
                  <li>
                    <a href="#security-considerations" class="toc-h2 toc-link" data-title="Security Considerations">Security Considerations</a>
                  </li>
                  <li>
                    <a href="#important-lost-passwords" class="toc-h2 toc-link" data-title="IMPORTANT: Lost Passwords">IMPORTANT: Lost Passwords</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#how-to" class="toc-h1 toc-link" data-title="How To">How To</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#client-side-setup" class="toc-h2 toc-link" data-title="Client-side setup">Client-side setup</a>
                  </li>
                  <li>
                    <a href="#usage" class="toc-h2 toc-link" data-title="Usage">Usage</a>
                  </li>
                  <li>
                    <a href="#example-sql-schema" class="toc-h2 toc-link" data-title="Example: SQL Schema">Example: SQL Schema</a>
                  </li>
                  <li>
                    <a href="#next-steps" class="toc-h2 toc-link" data-title="Next Steps">Next Steps</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#funding-hedgehog-accounts" class="toc-h1 toc-link" data-title="Funding Hedgehog Accounts">Funding Hedgehog Accounts</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#fund-user-wallets" class="toc-h2 toc-link" data-title="Fund User Wallets">Fund User Wallets</a>
                  </li>
                  <li>
                    <a href="#eip-712-relay-transactions" class="toc-h2 toc-link" data-title="EIP-712 Relay Transactions">EIP-712 Relay Transactions</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#best-practices" class="toc-h1 toc-link" data-title="Best practices">Best practices</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#password-strength" class="toc-h2 toc-link" data-title="Password Strength">Password Strength</a>
                  </li>
                  <li>
                    <a href="#rate-limiting" class="toc-h2 toc-link" data-title="Rate limiting">Rate limiting</a>
                  </li>
                  <li>
                    <a href="#javascript-security" class="toc-h2 toc-link" data-title="Javascript security">Javascript security</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#api" class="toc-h1 toc-link" data-title="API">API</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#signup" class="toc-h2 toc-link" data-title="signUp">signUp</a>
                  </li>
                  <li>
                    <a href="#login" class="toc-h2 toc-link" data-title="login">login</a>
                  </li>
                  <li>
                    <a href="#logout" class="toc-h2 toc-link" data-title="logout">logout</a>
                  </li>
                  <li>
                    <a href="#isloggedin" class="toc-h2 toc-link" data-title="isLoggedIn">isLoggedIn</a>
                  </li>
                  <li>
                    <a href="#getwallet" class="toc-h2 toc-link" data-title="getWallet">getWallet</a>
                  </li>
                  <li>
                    <a href="#restorelocalwallet" class="toc-h2 toc-link" data-title="restoreLocalWallet">restoreLocalWallet</a>
                  </li>
                  <li>
                    <a href="#createwallet" class="toc-h2 toc-link" data-title="createWallet">createWallet</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#code-organization" class="toc-h1 toc-link" data-title="Code Organization">Code Organization</a>
          </li>
          <li>
            <a href="#live-demo" class="toc-h1 toc-link" data-title="Live Demo">Live Demo</a>
          </li>
      </ul>
        <ul class="toc-footer">
            <li><a href='https://hedgehog.audius.co'>Hedgehog Public Site</a></li>
            <li><a href='https://github.com/AudiusProject/hedgehog'>Hedgehog Repository</a></li>
            <li><a href='https://github.com/lord/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <p><br />
<br /></p>

<p><strong>Hedgehog</strong> is alternative to Metamask that manages a user&#39;s private key and wallet on the browser. It exposes a simple API to allow you to create an authentication scheme to let users sign up and login to their wallet 
across multiple browsers and devices. <a href="https://hedgehog.audius.co">hedgehog.audius.co</a>.</p>

<p><br /></p>

<p><strong>Why Use This?</strong>
Not All Transactions Are Created Equal! Currently available wallets treat every transaction as if it were moving around your lifeâ€™s savings. Hedgehog was built for use-cases involving low-to-no financial value.</p>
<h1 id='installation'>Installation</h1>
<p>Hedgehog is available as an <a href="#">npm package</a>. </p>
<pre class="highlight plaintext"><code>npm install --save @audius/hedgehog
</code></pre><h1 id='overview'>Overview</h1>
<p>The following sections are a technical overview of how Hedgehog works, for coded examples, skip to the <a href="#how-to">How To</a> section.</p>

<p><img src="https://user-images.githubusercontent.com/2731362/58212636-4e33a900-7ca4-11e9-9fdd-ac3cd16dc6f0.png" title="Hedgehog System Diagram" alt="Hedgehog System Diagram" /></p>
<h1 id='how-it-works'>How It Works</h1>
<p>Hedgehog is a package that lives in your front end application to create and manage a user&#39;s entropy (from which a private key is derived). It allows your application to interact with a REST API on a server and database of your choice to securely persist and retrieve auth artifacts. Hedgehog relies on username and password to create auth artifacts, so it&#39;s able to simulate a familiar authentication system that allows users to sign up or login from multiple browsers or devices and retrieve their entropy.</p>

<p>Since Hedgehog interacts with a REST API, it requires that you run a server or database, or use a managed solution, and conform to the API specified in the <a href="#how-to">How To</a> section below.</p>

<p>Hedgehog generates a set of artifacts similar to a MyEtherWallet keystore file. Those artifacts can then be persisted to a database of your choice and retrieved with a hash computed from the username, password and an initialization vector. The private key is only computed and available client side and is never transmitted or stored anywhere besides the user&#39;s browser.</p>
<h2 id='wallet-creation'>Wallet Creation</h2>
<p>Wallets are created by first generating a wallet seed and entropy as per the <a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP-39 spec</a>. The entropy can then be used to derive a hierarchical deterministic wallet given a path, as stated in the <a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP-32 spec</a>. This entropy is stored in the browser&#39;s <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage#Browser_compatibility">localStorage</a> to allow user state to persist across multiple sessions without any external dependency. Using this entropy, a wallet object from <code>ethereumjs-wallet</code> is generated and stored in the <code>wallet</code> property within the Hedgehog class on initialization, enabling state persistence.</p>

<p>In addition to the entropy, Hedgehog generates an initialization vector(<code>iv</code>), <code>lookupKey</code> and <code>cipherText</code>. These three values can be securely stored in a database and retrieved from a server to authenticate a user. The <code>iv</code> is a random hex string generated for each user to secure authentication. The <code>lookupKey</code> is the username and password combined with a pre-defined, constant, initialization vector(not the same <code>iv</code> that&#39;s stored in the database). This <code>lookupKey</code> acts as the primary key in the database to retrieve the <code>cipherText</code> and <code>iv</code> values. The <code>cipherText</code> is generated using an aes-256-cbc cipher with the <code>iv</code> and a key derived from a combination of the user&#39;s password and the iv using <a href="https://en.wikipedia.org/wiki/Scrypt">scrypt</a> and stores the entropy. </p>

<p>Since entropy is stored in the <code>cipherText</code>, it can be derived from there if we know the <code>iv</code> and key(scrypt of user&#39;s password and <code>iv</code>). After the entropy is decrypted, it&#39;s stored in the browser on a local <code>ethereumjs-wallet</code> object as well as in localStorage. The encryption and decryption process happens exclusively on the client side with the user&#39;s password or entropy never leaving the browser without first being encrypted.</p>

<p>For API of functions to access and modify wallet state, please see the <a href="#api">API</a> section</p>
<h2 id='wallet-persistence'>Wallet Persistence</h2>
<p>The wallet information can be persisted on the backend of your choice. You, as the developer, have the choice to pick which language and frameworks to use, write the endpoints to suit any custom logic necessary and select  a hosting provider (if any). </p>

<p>The database schema for persisting data should resemble the following example. There two tables, one for storing authentication information, and the other for storing username and walletAddress. It&#39;s important that the username is not stored in the Authentications table because the <code>lookupKey</code> is a scrypt hash of a predefined iv with an username and password combination. If the data in these tables were ever exposed, susceptibility of a <a href="https://en.wikipedia.org/wiki/Rainbow_table">rainbow table attack</a> could increase because the password is the only unknown property. These tables can be named anything since Hedgehog only interacts with REST API endpoints that will perform CRUD on these tables.</p>
<h2 id='security-considerations'>Security Considerations</h2>
<p>All third party javascript should be audited for localStorage access. One possible attack vector is a script that loops through all localStorage keys and sends them to a third party server from where those keys could be used to sign transactions on behalf of malicious actors. To mitigate this, all third party javascript should be audited and stored locally to serve, instead of being loaded dynamically through scripts.</p>

<p>Username should be stored separately from auth artifacts in different tables. The table containing the authentication values should be independent with no relation to the table storing username</p>

<p>If the application developersâ€™ server is seized, breached, or controlled by bad actors, the resources required to brute-force decrypt the auth artifacts stored there would be immense. It would only make sense to expend those resources if there were enough value to be gained by breaking a given account, which is why we only recommend using Hedgehog in cases where the stakes are lower. This is also why we recommend a bridge approach for certain use-cases, where one could start users on Hedgehog and suggest migrating to a more secure wallet if their stored value increases beyond a certain threshold. We are working on fallback mechanisms to enable key sharing between devices in the absence of this server component, eg. QR codes.</p>

<p>For more deployment best practices please see <a href="#best-practices">this section</a></p>
<h2 id='important-lost-passwords'>IMPORTANT: Lost Passwords</h2>
<p>If a user loses their password, the account is no longer recoverable. There&#39;s no way to reset a password because the entropy is encrypted client side before it&#39;s sent to the database. And since the old password is required to decrypt the entropy and re-encrypt with a new password, if the password used to encrypt the entropy has been lost or forgotten, the account is not recoverable.</p>
<h1 id='how-to'>How To</h1>
<p>The code below shows code snippets to integrate Hedgehog into your own application. For more information about setting up a database schema, see the <a href="#example-sql-schema">example schema section</a>, and for a fully working end-to-end demo with a custom backend (Firebase or Express), see the <a href="https://github.com/AudiusProject/hedgehog-demo">demo repo</a>.</p>
<h2 id='client-side-setup'>Client-side setup</h2>
<p>In this example, we assume you have already a backend/database set up to handle the following scenarios:</p>

<p><strong><code>POST /authentication</code></strong></p>

<table><thead>
<tr>
<th>param</th>
<th>type</th>
</tr>
</thead><tbody>
<tr>
<td><code>iv</code></td>
<td>string</td>
</tr>
<tr>
<td><code>cipherText</code></td>
<td>string</td>
</tr>
<tr>
<td><code>lookupKey</code></td>
<td>string</td>
</tr>
</tbody></table>

<p>Inserts <code>iv</code>, <code>cipherText</code>, and <code>lookupKey</code> into the authentication table.</p>

<p><strong><code>GET /authentication</code></strong></p>

<table><thead>
<tr>
<th>param</th>
<th>type</th>
</tr>
</thead><tbody>
<tr>
<td><code>lookupKey</code></td>
<td>string</td>
</tr>
</tbody></table>

<p>Retrieve one record with <code>lookupKey</code> from the authentication table.</p>

<p><strong><code>POST /users</code></strong></p>

<table><thead>
<tr>
<th>param</th>
<th>type</th>
</tr>
</thead><tbody>
<tr>
<td><code>username</code></td>
<td>string</td>
</tr>
<tr>
<td><code>walletAddress</code></td>
<td>string</td>
</tr>
</tbody></table>

<p>Inserts <code>username</code> and <code>walletAddress</code> into a users table.</p>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="p">{</span> <span class="nx">Hedgehog</span><span class="p">,</span> <span class="cm">/*WalletManager, Authentication */</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'@audius/hedgehog'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">axios</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'axios'</span><span class="p">)</span>


<span class="kr">const</span> <span class="nx">makeRequestToService</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">axiosRequestObj</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">axiosRequestObj</span><span class="p">.</span><span class="nx">baseURL</span> <span class="o">=</span> <span class="s1">'http://hedgehog.base-url.com'</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">axios</span><span class="p">(</span><span class="nx">axiosRequestObj</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">data</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`Server returned error: </span><span class="p">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="s2"> </span><span class="p">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]}</span><span class="s2">`</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`Server returned error: </span><span class="p">${</span><span class="nx">e</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="s2"> </span><span class="p">${</span><span class="nx">e</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]}</span><span class="s2">`</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Next,</p>

<p>Import Hedgehog and necessary dependencies. Hedgehog is the package export that should be used by most users.
WalletManager and Authentication imports are possible but not recommended and should only be used by advanced users.</p>
<h3 id='makerequesttoservice'>makeRequestToService</h3>
<p>This is a helper function that makes XHR requests to a server of your choosing and parses the response status code.
This is simply a helper to make defining our setters and getters easier.</p>

<p>The Hedgehog constructor requires 3 parameters to set and retrieve data from your backend. These are:</p>
<h3 id='setauthfn'>setAuthFn</h3>
<p>Responsible for setting values into the authentication table on the backend.</p>

<p>On the backend, the <code>/authentication</code> route will need to insert an entry into the authentication table containing the iv, cipherText, and lookupKey.</p>
<pre class="highlight javascript tab-javascript"><code><span class="cm">/**
 * @param {Object} obj contains {iv, cipherText, lookupKey}
 */</span>
<span class="kr">const</span> <span class="nx">setAuthFn</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">await</span> <span class="nx">makeRequestToService</span><span class="p">({</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'/authentication'</span><span class="p">,</span>
    <span class="na">method</span><span class="p">:</span> <span class="s1">'post'</span><span class="p">,</span>
    <span class="na">data</span><span class="p">:</span> <span class="nx">obj</span>
  <span class="p">})</span>
<span class="p">}</span>

</code></pre><h3 id='setuserfn'>setUserFn</h3>
<p>Similarly to setAuthFn, the setUserFn is used to relay user information to our custom backend users table.</p>

<p>On the backend, the <code>/user</code> route will need to insert an entry into the users table containing the walletAddress and username.</p>
<pre class="highlight javascript"><code><span class="cm">/**
 * @param {Object} obj contains {walletAddress, username}
 */</span>
<span class="kr">const</span> <span class="nx">setUserFn</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">await</span> <span class="nx">makeRequestToService</span><span class="p">({</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'/user'</span><span class="p">,</span>
    <span class="na">method</span><span class="p">:</span> <span class="s1">'post'</span><span class="p">,</span>
    <span class="na">data</span><span class="p">:</span> <span class="nx">obj</span>
  <span class="p">})</span>
<span class="p">}</span>

</code></pre><h3 id='getfn'>getFn</h3>
<p>The getFn used to retrieve a record from the authentication table.</p>
<pre class="highlight javascript tab-javascript"><code><span class="cm">/**
 * @param {Object} obj contains {lookupKey}
 */</span>
<span class="kr">const</span> <span class="nx">getFn</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">makeRequestToService</span><span class="p">({</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'/authentication'</span><span class="p">,</span>
    <span class="na">method</span><span class="p">:</span> <span class="s1">'get'</span><span class="p">,</span>
    <span class="na">params</span><span class="p">:</span> <span class="nx">obj</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>
<p>After setting up these methods, we&#39;re good to go and ready let users create accounts &amp; sign in!</p>
<h2 id='usage'>Usage</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">hedgehog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hedgehog</span><span class="p">(</span><span class="nx">getFn</span><span class="p">,</span> <span class="nx">setAuthFn</span><span class="p">,</span> <span class="nx">setUserFn</span><span class="p">)</span>

<span class="c1">// wallet is an `ethereumjs-wallet` object that can be used to sign transactions</span>
<span class="kd">let</span> <span class="nx">wallet</span> <span class="o">=</span> <span class="kc">null</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">hedgehog</span><span class="p">.</span><span class="nx">isLoggedIn</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">wallet</span> <span class="o">=</span> <span class="nx">hedgehog</span><span class="p">.</span><span class="nx">getWallet</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Prompt user for username/password input for login or signup</span>
    <span class="nx">wallet</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">hedgehog</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">)</span>
    <span class="c1">// or</span>
    <span class="nx">wallet</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">hedgehog</span><span class="p">.</span><span class="nx">signUp</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<p>Here, we:</p>

<ol>
<li>Construct a new Hedgehog instance using our getFn, setAuthFn, and setUserFn.</li>
<li>Create a variable to store a wallet</li>
<li>Check if a user is logged in and set their wallet accordingly</li>
<li>If not, we can either log in a user with their credentials or sign up for a new account</li>
</ol>
<h2 id='example-sql-schema'>Example: SQL Schema</h2>
<p>There are two tables that should be used to persist hedgehog authentication and user information. The names of the tables and columns can be customized. For a full working example of a server and SQL schema, see the <a href="https://github.com/AudiusProject/hedgehog-demo">Hedgehog demo repo</a>.</p>
<h3 id='authentications'>Authentications</h3>
<p>This table stores auth information like <code>iv</code> and <code>cipherText</code> and also the <code>lookupKey</code>, which should serve as the primary key for this table since it&#39;s sent from the browser to request an auth record.</p>

<p>The values and explanation for fields in the Authentications table (<code>iv</code>, <code>cipherText</code> and <code>lookupKey</code>) are given in the <a href="#wallet-creation">Wallet creation</a> section.</p>

<p>An example of the Authentications table with example data:</p>

<table><thead>
<tr>
<th>iv</th>
<th>cipherText</th>
<th>lookupKey</th>
</tr>
</thead><tbody>
<tr>
<td>c9b3...48</td>
<td>07...e561</td>
<td>0e...2a8</td>
</tr>
<tr>
<td>d6...355</td>
<td>059f...561</td>
<td>15e...3c0</td>
</tr>
<tr>
<td>99...6e</td>
<td>f4...07</td>
<td>18...10</td>
</tr>
</tbody></table>
<h3 id='users'>Users</h3>
<p>This table can store information about users. The the two default fields hedgehog returns in the <code>setUserFn</code> call are <code>username</code> and <code>walletAddress</code>. <code>username</code> should serve as the primary key for the table.</p>
<h2 id='next-steps'>Next Steps</h2>
<p>After setting up Hedgehog, in order to fund wallets so that transactions can be waived on behalf of the user, see <a href="#funding-hedgehog-accounts">Funding Hedgehog Accounts</a> as well as other <a href="#best-practices">best practices</a>.</p>
<h1 id='funding-hedgehog-accounts'>Funding Hedgehog Accounts</h1>
<p>Since Hedgehog creates and manages wallets client side, just like Metamask, the problem of funding a wallet still exists. When performing only reads from a blockchain, there&#39;s usually no transaction fee. However, write transactions typically require fees, and the onus is on the transaction sender to pay these fees. </p>

<p>This is less than ideal for an end user facing product since users will be required to pay when submitting transactions - without a technology or cryptocurrency background, self-funding wallets is an unrealistic requirement.</p>

<p>There are two ways to try to solve this problem: <strong>funding user wallets</strong> or <strong>using EIP-712 relay transactions</strong>.</p>
<h2 id='fund-user-wallets'>Fund User Wallets</h2>
<p>As part of the endpoint which persists the walletAddress, you can fund any new <code>walletAddress</code>&#39;s created. When a new wallet is created, you could send a small amount of tokens to that address so the user can sign and send transactions to the chain browser side. The downside is there could be potential for abuse where someone farms accounts to collect tokens because these accounts would be funded directly. </p>
<h2 id='eip-712-relay-transactions'>EIP-712 Relay Transactions</h2>
<p>Another option is to have users sign their transactions browser side, but relay their transaction through an EIP-712 relayer which submits their transaction to chain. Any transaction costs incurred would be paid by the relayer instead of the user, however the original user transaction data is preserved and submitted.</p>

<p>For more information about EIP-712, please see the following links:</p>

<p><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-712.md">https://github.com/ethereum/EIPs/blob/master/EIPS/eip-712.md</a></p>

<p><a href="https://medium.com/metamask/eip712-is-coming-what-to-expect-and-how-to-use-it-bb92fd1a7a26">https://medium.com/metamask/eip712-is-coming-what-to-expect-and-how-to-use-it-bb92fd1a7a26</a></p>
<h1 id='best-practices'>Best practices</h1><h2 id='password-strength'>Password Strength</h2>
<p>It&#39;s recommended to enforce password standards client side to reject any insecure passwords. Two recommendations to increase password strength are to enforce a minimum character limit and use a bloom filter to reject commonly used passwords like this <a href="https://github.com/mozilla/fxa-common-password-list">npm module from Mozilla</a></p>
<h2 id='rate-limiting'>Rate limiting</h2>
<p>The server endpoint that is called by <a href="#client-side-setup">getFn</a> should be rate limited to prevent brute force attacks</p>
<h2 id='javascript-security'>Javascript security</h2>
<p>All client side code should be audited for localStorage since the entropy resides in localStorage. Please see the <a href="#security-considerations">security considerations</a> section for more information</p>
<h1 id='api'>API</h1>
<p>The functions exposed via hedgehog are:</p>
<h2 id='signup'>signUp</h2><pre class="highlight javascript tab-javascript"><code><span class="cm">/**
  * @param {String} username username
  * @param {String} password user password
  * @returns {Object} ethereumjs-wallet wallet object
  */</span>
<span class="nx">async</span> <span class="nx">signUp</span> <span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
</code></pre>
<blockquote>
<p>Example</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">wallet</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">hedgehog</span><span class="p">.</span><span class="nx">signUp</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">)</span>
</code></pre>
<p>Given user credentials, create a client side wallet and all other authentication artifacts, call setFn to persist the artifacts to a server and return the wallet object</p>
<h2 id='login'>login</h2><pre class="highlight javascript"><code><span class="cm">/**
  * @param {String} username username
  * @param {String} password user password
  * @returns {Object} ethereumjs-wallet wallet object
  */</span>
<span class="nx">async</span> <span class="nx">login</span> <span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
</code></pre>
<blockquote>
<p>Example</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">wallet</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">hedgehog</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">)</span>
</code></pre>
<p>Given user credentials, attempt to get authentication artifacts from server using getFn, create the private key using the artifacts and the user password</p>
<h2 id='logout'>logout</h2><pre class="highlight javascript tab-javascript"><code><span class="nx">logout</span> <span class="p">()</span>
</code></pre>
<blockquote>
<p>Example</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="nx">hedgehog</span><span class="p">.</span><span class="nx">logout</span><span class="p">()</span>
</code></pre>
<p>Deletes the local client side wallet including entropy and all associated authentication artifacts</p>
<h2 id='isloggedin'>isLoggedIn</h2><pre class="highlight javascript tab-javascript"><code>
<span class="cm">/**
  * @returns {Boolean} true if the user has a client side wallet, false otherwise
  */</span>
<span class="nx">isLoggedIn</span> <span class="p">()</span>
</code></pre>
<blockquote>
<p>Example</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="k">if</span> <span class="p">(</span><span class="nx">hedgehog</span><span class="p">.</span><span class="nx">isLoggedIn</span><span class="p">())</span> <span class="p">{</span> <span class="cm">/* show user account */</span> <span class="p">}</span>
</code></pre>
<p>Returns is the user has a client side wallet. If they do, calls can be made against that wallet, if they don&#39;t the user has to login or signup.</p>
<h2 id='getwallet'>getWallet</h2><pre class="highlight javascript tab-javascript"><code><span class="cm">/**
  * @returns {Object} ethereumjs-wallet wallet object if a wallet exists, otherwise null
  */</span>
<span class="nx">getWallet</span> <span class="p">()</span>
</code></pre>
<blockquote>
<p>Example</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">wallet</span> <span class="o">=</span> <span class="nx">hedgehog</span><span class="p">.</span><span class="nx">getWallet</span><span class="p">()</span>
</code></pre>
<p>Returns the current user wallet.</p>
<h2 id='restorelocalwallet'>restoreLocalWallet</h2><pre class="highlight javascript tab-javascript"><code><span class="cm">/**
   * @returns {Object/null} If the user has a wallet client side, the wallet object is returned,
   *                        otherwise null is returned
   */</span>
<span class="nx">restoreLocalWallet</span> <span class="p">()</span>
</code></pre>
<p>If a user refreshes or navigates away from the page and comes back later, this attempts to restore the client side wallet from localStorage, if it exists.</p>
<h2 id='createwallet'>createWallet</h2><pre class="highlight javascript tab-javascript"><code><span class="cm">/**
  * @param {String} password user password
  * @returns {Object} ethereumjs-wallet wallet object
  */</span>
<span class="nx">async</span> <span class="nx">createWallet</span> <span class="p">(</span><span class="nx">password</span><span class="p">)</span>
</code></pre>
<p>Create a new client side wallet object without going through the signup flow. This is useful if you need a temporary, read-only wallet that is ephemeral and does not need to be persisted.</p>
<h1 id='code-organization'>Code Organization</h1>
<p>The Hedgehog package is organized into several files with varying levels of control.</p>

<ul>
<li><b>index.js</b> - default exports for the npm module, exports each of the src/ modules below</li>
<li><b>src/hedgehog.js</b> -  main constructor with primary consumable public facing API and high level functions</li>
<li><b>src/walletManager.js</b> - wallet management logic including localStorage, and end to end authentication functionality</li>
<li><b>src/authentication.js</b> - low level authentication functions (eg create iv, encrypt hash etc)</li>
</ul>
<h1 id='live-demo'>Live Demo</h1>
<iframe src="https://codesandbox.io/embed/pp9zzv2n00?fontsize=14" title="Hedgehog Firebase Demo" style="width:100%;min-height:800px;height:800px;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>

      </div>
      <div class="dark-box">
      </div>
    </div>
  </body>
</html>
